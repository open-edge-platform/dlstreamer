name: Run Pylint
description: Lint Python files using pylint

inputs:
  path:
    description: Path to Python files or folder
    required: true
  output-file:
    description: Path to store the pylint output
    required: true
  name:
    description: Name of the artifact
    required: true
  enable-reviewdog:
    description: Enable ReviewDog PR comments
    required: false
    default: "false"
  github_token:
    description: GitHub token for ReviewDog
    required: false
  fail-on-findings:
    description: "Whether to fail the action if errors are found"
    required: false
    default: "true"

runs:
  using: "composite"
  steps:
    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 #v5.6.0
      with:
        python-version: '3.11'

    - name: Install Pylint
      run: |
        python -m pip install --upgrade pip
        pip install pylint
      shell: bash

    - name: Run pylint
      id: run-pylint
      env:
        path: ${{ inputs.path }}
        output_file: ${{ inputs.output-file }}
      run: |
        # Run pylint on all Python files at once for a single comprehensive score
        echo "ğŸ” Searching for Python files in: ${path}"
        python_files=$(find "${path}" -name "*.py" -not -path "*/venv/*" 2>/dev/null || true)

        if [ -n "${python_files}" ]; then
          echo "ğŸ“ Found Python files, running pylint..."
          find "${path}" -name "*.py" -not -path "*/venv/*" -print0 | xargs -0 pylint 2>&1 | tee "${output_file}" || true
        else
          echo "âš ï¸ No Python files found in ${path}" | tee "${output_file}"
        fi

        if [ ! -f "${output_file}" ]; then
          echo "No Python files found or pylint produced no output" > "${output_file}"
        fi
      shell: bash

    - name: Analyze Pylint results
      if: always()
      id: analyze-results
      env:
        path: ${{ inputs.path }}
        name: ${{ inputs.name }}
      run: |
        temp_output="${{ inputs.output-file }}.full"
        output_file="${{ inputs.output-file }}"

        if [ -f "${temp_output}" ]; then
          error_count=$(grep -cE "^[^:]+:[0-9]+:[0-9]+: E[0-9]+:" "${temp_output}" 2>/dev/null || echo "0")
          fatal_count=$(grep -cE "^[^:]+:[0-9]+:[0-9]+: F[0-9]+:" "${temp_output}" 2>/dev/null || echo "0")
          warning_count=$(grep -cE "^[^:]+:[0-9]+:[0-9]+: W[0-9]+:" "${temp_output}" 2>/dev/null || echo "0")
          critical_issues=$((error_count + fatal_count))
          echo "critical_issues=$critical_issues" >> $GITHUB_OUTPUT
          echo "warning_count=$warning_count" >> $GITHUB_OUTPUT

          echo "### Pylint Results for ${name}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”´ **Fatal**: $fatal_count" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ **Errors**: $error_count" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸ **Warnings**: $warning_count" >> $GITHUB_STEP_SUMMARY

          if [ "$critical_issues" -gt 0 ]; then
            echo "ğŸ”´ **$critical_issues critical issues found!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **No critical issues found!**" >> $GITHUB_STEP_SUMMARY
          fi
          rm -f "${temp_output}"
        else
          echo "warning_count=0" >> $GITHUB_OUTPUT
          echo "critical_issues=0" >> $GITHUB_OUTPUT
        fi
      shell: bash

    - name: Upload Pylint report (Critical Issues Only)
      if: always()
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
      with:
        name: pylint-report-${{ inputs.name }}
        path: ${{ inputs.output-file }}

    - name: Run ReviewDog (Pylint) - Critical Issues Only
      if: ${{ inputs.enable-reviewdog == 'true' && steps.analyze-results.outputs.critical_issues> 0 }}
      uses: dciborow/action-pylint@cf6c9bcd79e4aa70e2fbeaf6332d741eb1e0bff8
      with:
        github_token: ${{ inputs.github_token }}
        reporter: github-pr-review
        level: error
        workdir: ${{ inputs.path }}

    - name: Fail if Pylint found issues
      if: inputs.fail-on-findings == 'true'
      shell: bash
      env:
        output_file: ${{ inputs.output-file }}
      run: |
        critical_issues="${{ steps.analyze-results.outputs.critical_issues }}"
        warning_count="${{ steps.analyze-results.outputs.warning_count }}"
        if [ "$critical_issues" -gt 0 ]; then
          echo "âŒ Pylint found $critical_issues error(s). Failing the job."
          exit 1
        elif [ "$warning_count" -gt 0 ]; then
          echo "âœ… Pylint found $warning_count issue(s) but no errors. Job will continue."
          echo "ğŸ“‹ Issues found: warnings, info, or notes that should be reviewed."
        else
          echo "âœ… No Pylint issues found."
        fi
