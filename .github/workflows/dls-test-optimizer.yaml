name: "[DLS] [U24] Test optimizer"
run-name: "[DLS] [U24] Test optimizer (by ${{ github.actor }})"
on:
  workflow_call:
    inputs:
      test-repo-branch:
        description: "Branch in dl-streamer-tests repo (default is main)"
        required: false
        type: string
        default: "main"
  workflow_dispatch:
    inputs:
      test-repo-branch:
        description: "Branch in dl-streamer-tests repo (default is main)"
        required: false
        type: string
        default: "main"
permissions: {}
env:
  dlstreamer-version: "2025.2.0"
  MODELS_PATH: "$HOME/models"
  VIDEO_INPUTS_PATH: "$HOME/videos"
  DLS_REL_PATH: "./dlstreamer"
  OPTIMIZER_TESTS_PATH: "/home/runner/optimizer"

jobs:
  build:
    name: "[${{ matrix.runner_print_label }}] Build and test ${{ matrix.ubuntu_version }} .debs & deb imgs"
    runs-on: ${{ matrix.runner_labels }}
    permissions:
      contents: read
      packages: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - path_dockerfile: $DLS_REL_PATH/docker/ubuntu/ubuntu24.Dockerfile
            ubuntu_version: ubuntu24
            runner_labels: [self-hosted, dlstreamer, TGL, ubuntu24] # Build and run tests on Tiger Lake system with Ubuntu 24
            runner_print_label: TGL
    steps:
      - name: Initial environment clean
        run: |
          sudo rm -rf dlstreamer
      - name: Check out dlstreamer repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #5.0.0
        with:
          persist-credentials: false
          path: dlstreamer

      - name: Init submodules
        run: |
          cd dlstreamer
          git submodule update --init thirdparty/spdlog
      - name: Check out test repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 #4.2.2
        with:
          repository: open-edge-platform/dl-streamer-tests
          persist-credentials: false
          ref: ${{ inputs.test-repo-branch }}
          path: dl-streamer-tests-repo

      - name: Copy DL Streamer tests repo
        run: |
          mkdir $OPTIMIZER_TESTS_PATH
          cp -r dl-streamer-tests-repo/functional_tests $OPTIMIZER_TESTS_PATH
      # ======================================================== BUILDING PART ========================================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 #3.11.1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef #3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸš¢ Build deb final img with cache from GHCR
        env:
          deb_final_img: ghcr.io/${{ github.repository }}/deb-final-img-${{ matrix.ubuntu_version }}:${{ github.sha }}
          deb_final_img_cached: ghcr.io/${{ github.repository }}/deb-final-img-${{ matrix.ubuntu_version }}:buildcache
        run: |
          docker buildx build \
            --load \
            --target dlstreamer \
            --tag "${deb_final_img}" \
            --cache-from="${deb_final_img_cached}" \
            --build-arg DLSTREAMER_VERSION=${{ env.dlstreamer-version }} \
            --build-arg DLSTREAMER_BUILD_NUMBER=deb-pkg-${{ matrix.ubuntu_version }} \
            -f ${{ matrix.path_dockerfile }} \
            ${{ env.DLS_REL_PATH }}
      - name: Build dlstreamer img with python
        env:
          deb_final_img: ghcr.io/${{ github.repository }}/deb-final-img-${{ matrix.ubuntu_version }}:${{ github.sha }}
          deb_final_testing_img: ghcr.io/${{ github.repository }}/deb-final-testing-img-${{ matrix.ubuntu_version }}:${{ github.sha }}
        id: dlstreamer-with-python
        run: |
          docker build \
          -f $DLS_REL_PATH/docker/ubuntu/ubuntu-testing.Dockerfile \
          -t $deb_final_testing_img \
          --build-arg BASE_IMAGE=$deb_final_img \
          ${{ env.DLS_REL_PATH }}
      - name: ðŸ“¦ Extract .deb packages using script
        env:
          deb_final_img: ghcr.io/${{ github.repository }}/deb-final-img-${{ matrix.ubuntu_version }}:${{ github.sha }}
        run: |
          chmod +x ${{ env.DLS_REL_PATH }}/scripts/extract_and_verify_debs.sh
          ${{ env.DLS_REL_PATH }}/scripts/extract_and_verify_debs.sh ${deb_final_img}
          ls
          cp -r deb_packages ${{ env.DLS_REL_PATH }}
      # ======================================================== DOCKER TESTING PART ========================================================
      - name: Check models
        run: |
          echo "## ðŸ“‚ ${{ matrix.runner_print_label }} Environment checks" >> $GITHUB_STEP_SUMMARY
          echo "Test repo branch: $test_repo_branch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "${{ env.MODELS_PATH }}" ] && [ "$(ls -A "${{ env.MODELS_PATH }}")" ]; then
            echo "Models: found âœ…" >> $GITHUB_STEP_SUMMARY
          else
            echo "Models: folder not found or it is empty âŒ" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      - name: Check videos
        run: |
          if [ -d "${{ env.VIDEO_INPUTS_PATH }}" ] && [ "$(ls -A "${{ env.VIDEO_INPUTS_PATH }}")" ]; then
            echo "Tests input videos: found âœ…" >> $GITHUB_STEP_SUMMARY
          else
            echo "Tests input videos: folder not found or it is empty âŒ" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      - name: ðŸš€ Run optimizer in Docker
        id: run_optimizer_in_docker
        env:
          deb_final_img: ghcr.io/${{ github.repository }}/deb-final-img-${{ matrix.ubuntu_version }}:${{ github.sha }}
        run: |
          mkdir -p $OPTIMIZER_TESTS_PATH/optimizer_results/docker
          RENDER_GROUP_ID=$(getent group render | awk -F: '{printf "%s\n", $3}')
          docker run --rm \
            -v $OPTIMIZER_TESTS_PATH/functional_tests/optimizer_tests:/workspace/optimizer_tests \
            -v $OPTIMIZER_TESTS_PATH/optimizer_results/docker:/workspace/optimizer_results \
            -v ${{ env.MODELS_PATH }}:/home/dlstreamer/models \
            --device=/dev/dri \
            --group-add "$RENDER_GROUP_ID" \
            -w /workspace \
            ${deb_final_img} \
            bash /workspace/optimizer_tests/scripts/run_optimizer_tests.sh --config-file "/workspace/optimizer_tests/test_config.json" --results-path "$OPTIMIZER_TESTS_PATH/optimizer_results/docker"
      - name: Upload Docker test results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 #4.6.2
        with:
          name: DLS_optimizer_Docker_${{ matrix.runner_print_label }}_${{ matrix.ubuntu_version }}_results
          path: $OPTIMIZER_TESTS_PATH/optimizer_results/docker/FINAL_TEST_REPORT.txt

      # ======================================================== OH HOST TESTING PART ========================================================
      - name: Link DL Streamer to home directory
        if: always()
        run: |
          ln -s $PWD/$DLS_REL_PATH $HOME
      - name: Install DL Streamer on-host
        if: always()
        run: |
          $DLS_REL_PATH/tests/scripts/installation-on-host-entrypoint.sh $DLS_REL_PATH/deb_packages
      - name: Run Optimizer on host
        if: always()
        run: |
          mkdir $OPTIMIZER_TESTS_PATH/optimizer_results/host
          $OPTIMIZER_TESTS_PATH/functional_tests/optimizer_tests/scripts/run_optimizer_tests.sh --results-dir "$OPTIMIZER_TESTS_PATH/optimizer_results/host" --config-file "$OPTIMIZER_TESTS_PATH/functional_tests/optimizer_tests/test_config.json"

      - name: Upload host test results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 #4.6.2
        if: always()
        with:
          name: DLS_optimzier_host_${{ matrix.runner_print_label }}_on_host_${{ matrix.ubuntu_version }}_results
          path: $OPTIMIZER_TESTS_PATH/optimizer_results/host/FINAL_TEST_REPORT.txt
      - name: Uninstall dlstreamer
        if: always ()
        run: |
          $DLS_REL_PATH/tests/scripts/uninstall-dlstreamer.sh
      - name: Check Docker image size
        if: always()
        id: check-size
        env:
          deb_final_img: ghcr.io/${{ github.repository }}/deb-final-img-${{ matrix.ubuntu_version }}:${{ github.sha }}
        run: |
          IMAGE_NAME=${deb_final_img}
          if [ "${{ matrix.ubuntu_version }}" == "ubuntu22" ]; then
            EXPECTED_SIZE_MB=${{ vars.EXPECTED_SIZE_MB_DEB_U22 }}
          elif [ "${{ matrix.ubuntu_version }}" == "ubuntu24" ]; then
            EXPECTED_SIZE_MB=${{ vars.EXPECTED_SIZE_MB_DEB_U24 }}
          fi
          IMAGE_SIZE_BYTES=$(docker image inspect "$IMAGE_NAME" --format='{{.Size}}')
          IMAGE_SIZE_MB=$((IMAGE_SIZE_BYTES / 1024 / 1024))
          echo "Actual image size: ${IMAGE_SIZE_MB} MB"
          echo "Expected size: ${EXPECTED_SIZE_MB} MB"
          DIFF=$(( IMAGE_SIZE_MB - EXPECTED_SIZE_MB ))
          ABS_DIFF=${DIFF#-}
          echo "Difference: ${ABS_DIFF} MB"
          THRESHOLD_SIZE_MB=100
          echo "IMAGE_SIZE_MB=$IMAGE_SIZE_MB" >> $GITHUB_ENV
          echo "EXPECTED_SIZE_MB=$EXPECTED_SIZE_MB" >> $GITHUB_ENV
          if [ "$ABS_DIFF" -gt "$THRESHOLD_SIZE_MB" ]; then
            echo "âŒ Image size difference exceeds allowed threshold: ${THRESHOLD_SIZE_MB}MB (difference: ${ABS_DIFF} MB)"
            exit 1
          else
            echo "âœ… Image size within allowed threshold: ${THRESHOLD_SIZE_MB}MB."
          fi
      - name: Print image size summary
        if: always()
        env:
          IMAGE_SIZE_MB: ${{ env.IMAGE_SIZE_MB }}
          EXPECTED_SIZE_MB: ${{ env.EXPECTED_SIZE_MB }}
        run: |
          {
            echo "## ðŸ³ Docker image size"
            echo ""
            echo "| Image | Size |"
            echo "|-------|------|"
            echo "| Current Docker ${{ matrix.ubuntu_version }}-deb | **${IMAGE_SIZE_MB} MB** |"
            echo "| Expected Docker ${{ matrix.ubuntu_version }}-deb | **${EXPECTED_SIZE_MB} MB** |"
          } >> "$GITHUB_STEP_SUMMARY"
      # ======================================================== CLEAUP PART ========================================================
      - name: Clean up
        if: always ()
        env:
          deb_final_img: ghcr.io/${{ github.repository }}/deb-final-img-${{ matrix.ubuntu_version }}:${{ github.sha }}
        run: |
          rm -rf $HOME/.virtualenvs
          docker rmi ${deb_final_img} || true
          sudo rm -f $HOME/dlstreamer
          rm -rf dlstreamer
          rm -rf $HOME/dl-streamer-tests-repo
          docker system prune -a -f
          rm -rf $OPTIMIZER_TESTS_PATH
